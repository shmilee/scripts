## app name as key, any string, like short-version
declare -a AppNames=(
    'v100' # freeze, the final official version, 2025-08-26
)

## name: github-url, fmt: https://github.com/..????/????TV
declare -A AppUrls=(
    ['v100']='https://github.com/MoonTechLab/LunaTV'
)

## download https://github.com/..????/????TV/archive/${commit}.tar.gz
declare -A AppCommits=(
    ['v100']='3a201c75467b4873e2025f33e44b1fb811d13ba8' # 2025-10-31, archived on 2025-11-03
)

## app release version, fmt: X.Y.Z.rNNN
## X.Y.Z may not match the commit, but number of commits NNN does.
declare -A AppVersions=(
    ['v100']='100.0.3.r127'
)

## app patch files in dir patches/, a.patch:b.patch:...
## ---+++, a-name/src/xx/yy/zz vs what-patch/src/xx/yy/zz
COLLECT_PATCHES_0X='01-config-collections.patch:02-config-collections-cron.patch:02-config-collections-live.patch:03-config-collections-migu-video.patch'
MPV_PATCHES_1X='11-open-with-mpv-button.patch:11-open-with-mpv-page.patch:12-open-with-mpv-danmaku-xmlurl.patch:13-open-with-mpv-m3u8-register.patch'
PATCHES_SH='9501-replace-username.patch.sh:9502-off-no-console-warning.patch.sh'
declare -A AppPatches=(
    ['v100']="${COLLECT_PATCHES_0X}:${MPV_PATCHES_1X}:21-source-rank.patch:${PATCHES_SH}"
)
PatchVersion='3'

## which app's node_modules squashfs file to use, defult: v100
declare -A AppNodemodsNames=(
    ['defult']='v100'
)

## exclude app's node_modules in squashfs file
## fmt: extended patterns. default: '', exclude nothing
declare -A AppNodemodsExclude=(
    ['defult']=''
)

## which app's valkey dbfilename to use, defult: valkey-moontv.rdb
## fmt: valkey-Name.rdb
declare -A AppValkeydbfilenames=(
    ['defult']='valkey-moontv.rdb'
)

## config-collections/{moontv-XXXXX,iptv-XXXXX}
## fmt: [moontv-XXXXX]='url'
declare -A ConfigCollections=(
    ['moontv-hafrey1-config.txt']='https://github.com/hafrey1/LunaTV-config/raw/refs/heads/main/LunaTV-config.txt'
    ['iptv-dazui.m3u']='https://github.com/imDazui/Tvlist-awesome-m3u-m3u8/raw/refs/heads/master/m3u/江苏移动iptv.m3u'
    ['iptv-bestfan.m3u']='https://github.com/best-fan/iptv-sources/raw/refs/heads/main/cn_all_status.m3u8'
    #['iptv-Guovin-ipv4.m3u']='https://github.com/Guovin/iptv-api/raw/refs/heads/master/output/ipv4/result.m3u'
    #['iptv-YanG.m3u']='https://tv.iill.top/m3u/Gather'  # https://yang-1989.eu.org/
)

# download cmd/agent
CURLCMD='curl -fLC - --retry 3 --retry-delay 3 --proxy socks5://127.0.0.1:8387'

## Add other version apps
#AppNames+=('')
#AppUrls['']=''
#AppCommits['']=''
#AppVersions['']=''
#AppPatches['']=''           # optional
#AppNodemodsNames['']=''     # optional
#AppNodemodsExclude['']=''   # optional
#AppValkeydbfilenames['']='' # optional

V5S_COLLECT_PATCHES_0X='01-config-collections.patch:02-config-collections-cron-v5s-r621+.patch:02-config-collections-live.patch:03-config-collections-migu-video.patch'
V1D_COLLECT_PATCHES_0X='01-config-collections.patch:02-config-collections-cron.patch:02-config-collections-live-v1d-r184+.patch:03-config-collections-migu-video.patch'
V2P_MPV_PATCHES_1X='11-open-with-mpv-button.patch:11-open-with-mpv-page-v2p-r156+.patch:12-open-with-mpv-danmaku-xmlurl.patch:13-open-with-mpv-m3u8-register.patch'

V1D_PATCHES_SH="${PATCHES_SH}:9503-v1d-fix-truncate-title-mpv-button.patch.sh"
V5S_PATCHES_SH="${PATCHES_SH}:9504-v5s-fix-card-drop-shadow.patch.sh:9505-v5s-fix-cors-ua.patch.sh:9506-v5s-less-console-log.patch.sh"

# freeze, without UI with glass morphism, animations, loading effects
# then low CPU usage in browser during idle state
AppNames+=('v556')
AppUrls['v556']='https://github.com/SzeMeng76/LunaTV'
AppCommits['v556']='0ca0a27490029dad6590ad6e800bc2a85f0c6bb5' # 2025-10-09
AppVersions['v556']='5.5.6.r905'
AppPatches['v556']="${V5S_COLLECT_PATCHES_0X}:${MPV_PATCHES_1X}:21-source-rank.patch:901-fix-api-search-user-auth-8815e13.patch:${V5S_PATCHES_SH}"

# freeze, NOT upgrading to Next.js 16.1 + Tailwind CSS 4.1 + React 19
# then use same AppNodemodsNames as v100, and no turbopack resolve issue fix required
# Chrome recommended
AppNames+=('v571')
AppUrls['v571']='https://github.com/SzeMeng76/LunaTV'
AppCommits['v571']='897bfb5b70931d8bfe023752dc91faa7c600ca5b' # 2025-12-17
AppVersions['v571']='5.7.1.r1236'
AppPatches['v571']="${V5S_COLLECT_PATCHES_0X}:${MPV_PATCHES_1X}:21-source-rank.patch:${V5S_PATCHES_SH}"

# freeze, personal closed, /36fb82beb9f1b9f886392a391cc4fc39502dd64f
AppNames+=('v721')
AppUrls['v721']='https://github.com/joyce677/NewTV'
AppCommits['v721']='f60ddbfc878a291ded1790375bec9b1796e4515c' # 2025-09-22
AppVersions['v721']='7.2.1.r845'
AppPatches['v721']="${COLLECT_PATCHES_0X}:${MPV_PATCHES_1X}:21-source-rank.patch:901-fix-api-search-user-auth-8815e13.patch:${PATCHES_SH}"

# freeze, NOT upgrading to Next.js 16.1 + Tailwind CSS 4.1 + React 19, /e5b3aad
# then use same AppNodemodsNames as v100, and no turbopack resolve issue fix required
# Chrome recommended
AppNames+=('v080')
AppUrls['v080']='https://github.com/Decohererk/DecoTV'
AppCommits['v080']='7b59a29eabcdb7b8b951c4a0551225c83f33dc57' # 2025-12-15
AppVersions['v080']='0.8.0.r137'
AppPatches['v080']="${COLLECT_PATCHES_0X}:${MPV_PATCHES_1X}:21-source-rank.patch:${V1D_PATCHES_SH}"

# Upgrading; Chrome recommended
AppNames+=('v1d')
AppUrls['v1d']='https://github.com/Decohererk/DecoTV'
AppCommits['v1d']='2026f8fa52e56cfbd3ebb328972ca60073cb2e5d' # 2025-12-28
AppVersions['v1d']='1.0.0.r185'
AppPatches['v1d']="${V1D_COLLECT_PATCHES_0X}:${MPV_PATCHES_1X}:21-source-rank.patch:921-fix-nextjs16-turbopack-resolve-net-tls-v1d-v5s+.patch:${V1D_PATCHES_SH}"
AppNodemodsNames['v1d']='v1d'
AppNodemodsExclude['v1d']='esbuild-linux|img\+sharp-libvips-linux'

# Upgrading
AppNames+=('v2p')
AppUrls['v2p']='https://github.com/mtvpls/MoonTVPlus'
AppCommits['v2p']='636e6042c81a27a344702972b6a091674fc9ff24' # 2025-12-25
AppVersions['v2p']='204.0.0.r312'
AppPatches['v2p']="${V1D_COLLECT_PATCHES_0X}:${V2P_MPV_PATCHES_1X}:21-source-rank.patch:${PATCHES_SH}"
#AppNodemodsNames['v2p']='v2p'
AppValkeydbfilenames['v2p']='valkey-moonplus.rdb'

# Upgrading; Chrome recommended
AppNames+=('v5s')
AppUrls['v5s']='https://github.com/SzeMeng76/LunaTV'
AppCommits['v5s']='1acf0a805ff44b69c93d15f43d251a5e07167a93' # 2025-12-30
AppVersions['v5s']='5.9.0.r1533'
AppPatches['v5s']="${V5S_COLLECT_PATCHES_0X}:${MPV_PATCHES_1X}:21-source-rank.patch:921-fix-nextjs16-turbopack-resolve-net-tls-v1d-v5s+.patch:${V5S_PATCHES_SH}"
AppNodemodsNames['v5s']='v1d'
AppNodemodsExclude['v5s']='esbuild-linux|img\+sharp-libvips-linux'


## functions: get_xxx name
get_gituser() { echo "${AppUrls[$1]}" | awk -F/ '{print $4}'; }
get_gitrepo() { echo "${AppUrls[$1]}" | awk -F/ '{print $5}'; }
get_appver() { echo "${AppVersions[$1]}.g${AppCommits[$1]:0:7}-${PatchVersion}"; }
# appdir fmt: ???-????tv-version. lower? appdir="${appdir,,}"
get_appdir() { echo "$(get_gituser $1)-$(get_gitrepo $1)-v$(get_appver $1)"; }
get_tarball() { echo "$(get_gituser $1)-$(get_gitrepo $1)-v${AppVersions[$1]}.g${AppCommits[$1]:0:7}.tar.gz"; }
#get_showrepo() { echo "${AppUrls[$1]}" | sed 's|https://github.com/||'; }
get_showrepo() { echo "${AppUrls[$1]}" | sed 's|.*github.com/\(..\).*\(/.*$\)|\1?\2|' | sed 's|Plus|+|'; }
get_nodemodsname() { echo "${AppNodemodsNames[$1]:-${AppNodemodsNames['defult']}}"; }
get_nodemodsexclude() { echo "${AppNodemodsExclude[$1]:-${AppNodemodsExclude['defult']}}"; }
get_nodemodsquashfs() { echo "$(get_appdir $1)-node_modules.squashfs"; }
get_valkeydbfile() { echo "${AppValkeydbfilenames[$1]:-${AppValkeydbfilenames['defult']}}"; }


### Obsolete repos ###
##
##AppNames+=('v2s')
##AppUrls['v2s']='https://github.com/Stardm0/MoonTV'
##AppCommits['v2s']='a63d458988b2e451f7a276500902e9f7c8f16723' # 2025-09-04
### freeze, 2.8.0 /3d1ecf7e1cedabeaed97cbdfb42b297e7c2bde60 package.json changed
##AppVersions['v2s']='2.7.6.r87'
##AppPatches['v2s']="${MPV_PATCH_0X}:03-open-with-mpv-m3u8filter-v2s-live.patch:21-fix-bangumi.patch"
##
##AppNames+=('v0k')
##AppUrls['v0k']='https://github.com/katelya77/KatelyaTV'
##AppCommits['v0k']='3ce1bd1ce4be0e8663766959e18c16387f573fac' # 2025-09-05
### freeze, https://github.com/katelya77/KatelyaTV/issues/93
##AppVersions['v0k']='0.7.0.r198'
##AppNodemodsNames['v0k']='v0k'
##AppNodemodsExclude['v0k']='esbuild-linux|img\+sharp-libvips-linux'
##
##AppNames+=('v8o')
##AppUrls['v8o']='https://github.com/djteang/OrangeTV'
##AppCommits['v8o']='2194a3d6adf6cc169a32a18cea5b37bc2f93b2e7' # 2025-09-25
### inactive/dormant
##AppVersions['v8o']='8.9.5.r21'
### ignore WebSocket files for chatModal
### also patch different version of browserslist, ..., tapable etc.
##AppPatches['v8o']="${COLLECT_PATCHES_0X}:${MPV_PATCHES_1X}:21-source-rank.patch:901-fix-api-search-user-auth-8815e13.patch:911-disable-chatModal-v8o-r21+.patch"
