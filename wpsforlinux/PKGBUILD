# Maintainer: shmilee <echo c2htaWxlZS56anVAZ21haWwuY29tCg==|base64 -d>

_pkgname=wps-office
_pkgver='12.1.2.22571'
_srcOrigin="https://wps-linux-personal.wpscdn.cn"
_srcPath="/wps/download/ep/Linux2023/${_pkgver##*.}/wps-office_${_pkgver}.AK.preread.sw_480057_amd64.deb"
_srcParams() {
    # view-source:https://www.wps.cn/product/wpslinux#
    # https://gitlab.com/cwittlut/wps-tsk/-/blob/main/tsk.sh
    local secrityKey='7f8faaaa468174dc1c9cd62e5f218a5b'
    local timestamp=$(date '+%s') # epoch
    local md5hash=$(echo -n "${secrityKey}${_srcPath}${timestamp}" | md5sum)
    #echo "$md5hash" && exit 1
    echo "t=${timestamp}&k=${md5hash%% *}"
}

pkgbase=wpsforlinux
pkgname=('wpsoffice')
pkgver=${_pkgver/\~/_}
pkgrel=1
arch=('x86_64')
groups=('wpsforlinux')
license=('custom:Kingsoft')
url='http://wps-community.org/'
conflicts=('wps-office' 'kingsoft-office' 'wps-office-cn')
options=(!emptydirs !strip)
source=("wps-office_${pkgver}_amd64.deb::${_srcOrigin}${_srcPath}?$(_srcParams)"
        #"https://archive.org/download/archlinux_pkg_freetype2/freetype2-2.13.0-1-x86_64.pkg.tar.zst"
        'wps-office.xml')
sha256sums=('681d4458fd04bf95ae02ece2877c9b0f6dea6914535239444b57a66acfac5030'
            '24b3c218d16d8da3f1de52f013cf02cf1af580548336eb0d77777a8b08630676')

#PKGEXT='.pkg.tar' ##reduce the time of compression

_etMT="MimeType=application\/wps-office.et;application\/wps-office.ett;application\/vnd.ms-excel;\
application\/vnd.openxmlformats-officedocument.spreadsheetml.template;\
application\/vnd.openxmlformats-officedocument.spreadsheetml.sheet;\
text\/csv;"
_wppMT="MimeType=application\/wps-office.dps;application\/wps-office.dpt;application\/vnd.ms-powerpoint;\
application\/vnd.openxmlformats-officedocument.presentationml.presentation;\
application\/vnd.openxmlformats-officedocument.presentationml.slideshow;\
application\/vnd.openxmlformats-officedocument.presentationml.template;"
_wpsMT="MimeType=application\/wps-office.wps;application\/wps-office.wpt;\
application\/msword;application\/msword-template;application\/rtf;\
application\/vnd.openxmlformats-officedocument.wordprocessingml.template;\
application\/vnd.openxmlformats-officedocument.wordprocessingml.document;"

package_wpsoffice() {
    arch=('x86_64')
    pkgdesc='WPS Office, including Writer, Presentation and Spreadsheets, is a powerful office productivity suite. (no fonts)'
    depends=('fontconfig' 'xorg-mkfontdir' 'libxrender'
             'desktop-file-utils' 'shared-mime-info' 'xdg-utils'
             'glu' 'sdl2' 'libpulse'
             'hicolor-icon-theme' 'libxml2-legacy'
             'libxss' 'sqlite' 'libtool' 'libxslt')
    optdepends=('cups: for printing support'
                'libjpeg-turbo: JPEG image codec support'
                'pango: for complex (right-to-left) text support'
                'curl: An URL retrieval utility and library'
                'ttf-wps-fonts: Symbol fonts required by wps-office'
                'ttf-ms-fonts: Microsft Fonts recommended for wps-office'
                'wps-office-fonts: FZ TTF fonts provided by wps community')
    install=wpsoffice.install

    cd "${srcdir}"
    tar xv -C "${pkgdir}" -f data.tar.xz

    msg2 "editing mime files: wps-office-{et,wpp,wps,pdf}.xml ..."
    rm -f "$pkgdir"/usr/share/mime/packages/*wps-office*.xml
    rm -rf "$pkgdir"/opt/kingsoft/wps-office/INSTALL/
    install -Dm644 wps-office.xml "$pkgdir"/usr/share/mime/packages/wps-office.xml

    msg2 "editing desktop files: wps-office-{et,wpp,wps}.desktop, with shared-mime-info ..."
    rm -rf "${pkgdir}"/opt/kingsoft/wps-office/desktops/
    #_et
    sed -i "s/^MimeType.*$/$_etMT/" "$pkgdir"/usr/share/applications/wps-office-et.desktop
    #_wpp
    sed -i "s/^MimeType.*$/$_wppMT/" "$pkgdir"/usr/share/applications/wps-office-wpp.desktop
    #_wps
    sed -i "s/^MimeType.*$/$_wpsMT/" "$pkgdir"/usr/share/applications/wps-office-wps.desktop

    cd "$pkgdir"/usr/share/applications/
    for desktop in *.desktop; do
        # fix: BOM
        if grep -r -I -l $'^\xEF\xBB\xBF' "$desktop" 2>&1 >/dev/null; then
            msg2 "Remove BOM (Byte-order mark) in utf-8 $desktop file ..."
            sed -i 's/^\xEF\xBB\xBF//;' "$desktop"
        fi
        # fix: Categories=Office;...
        local Categories=$(grep 'Categories=' "$desktop")
        local Office=$(echo $Categories | grep Office)
        if [ -n "$Categories" -a -z "$Office" ]; then
            msg2 "Add Office category in $desktop file ..."
            sed -i "s|\(Categories=\)\(.*$\)|\1Office;\2|" "$desktop"
        fi
    done

    # fix wps update log logrotate error
    # sed 's|su root|su root root|' "$pkgdir"/etc/logrotate.d/wpsupdatelog
    # or rm wps update
    cd "$pkgdir"/etc/
    rm -rf cron.d/ logrotate.d/ xdg/autostart/

    # license
    for _ext in "txt" "html"; do
        if [ -f "$pkgdir/opt/kingsoft/wps-office/office6/mui/default/EULA_linux.${_ext}" ]; then
            install -dm755 "$pkgdir/usr/share/licenses/${_pkgname}"
            ln -sv "/opt/kingsoft/wps-office/office6/mui/default/EULA_linux.${_ext}" \
                "$pkgdir/usr/share/licenses/${_pkgname}/EULA.${_ext}"
            break
        fi
    done

    # fix libstdc++.so.6: version `GLIBCXX_3.4.30' not found (required by /usr/lib/libicuuc.so.72)
    rm -vf "${pkgdir}"/opt/kingsoft/wps-office/office6/libstdc++.so*
    # Use system libjpeg
    rm -vf "${pkgdir}"/opt/kingsoft/wps-office/office6/libjpeg.so*
    # Use system libcurl, fix libcurl.so.4.8.0: version `OPENSSL_1_1_1b' not found
    rm -vf "${pkgdir}"/opt/kingsoft/wps-office/office6/libcurl.so*

    ## fix bold fonts, black cloud error, freetype2 so.6.19.0
    #install -vDm755 "${srcdir}"/usr/lib/libfreetype.so.6.19.0 "${pkgdir}"/opt/kingsoft/wps-office/office6/libfreetype.so.6.19.0
    #ln -vs libfreetype.so.6.19.0 "${pkgdir}"/opt/kingsoft/wps-office/office6/libfreetype.so.6
    #ln -vs libfreetype.so.6 "${pkgdir}"/opt/kingsoft/wps-office/office6/libfreetype.so

    # others
    cd "$pkgdir/opt/kingsoft/wps-office/office6/"
    # libcef.so not found
    if [ -f ./addons/cef/libcef.so -a ! -f ./libcef.so ]; then
        ln -vs addons/cef/libcef.so ./libcef.so
    fi
    # libbz2.so borken link
    if [ -L ./libbz2.so -a ! -e ./libbz2.so ]; then
        rm -v ./libbz2.so
    fi
    # disable wpscloudsvr etc.
    for back in transerr wpscloudsvr; do # wpsoffice
        if [ -f "${back}" ]; then
            chmod -x "${back}"
            mv -v "${back}" "${back}.bk"
        fi
    done

    # fix 双击打开文件: WPS 全局设置中切换窗口管理模式, 改成多组件模式
    # TODO 横版打印？竖版？test PDF etc.
    # ref: https://aur.archlinux.org/packages/wps-office-cn?O=0
}
