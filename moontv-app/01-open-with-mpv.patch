diff -Nur v100/src/app/api/danmaku-xmlurl/route.ts open-with-mpv/src/app/api/danmaku-xmlurl/route.ts
--- v100/src/app/api/danmaku-xmlurl/route.ts	1970-01-01 08:00:00.000000000 +0800
+++ open-with-mpv/src/app/api/danmaku-xmlurl/route.ts	2025-09-28 15:15:16.347623959 +0800
@@ -0,0 +1,558 @@
+/* eslint-disable @typescript-eslint/no-explicit-any, no-console */
+
+import { NextRequest, NextResponse } from 'next/server';
+
+interface PlatformUrl {
+  platform: string;
+  url: string;
+}
+
+// ä»caiji.cyou APIæœç´¢è§†é¢‘é“¾æ¥
+async function searchFromCaijiAPI(title: string, episode?: string | null): Promise<PlatformUrl[]> {// {{{
+  try {
+    console.log(`ğŸ” åœ¨caiji.cyouæœç´¢: "${title}", é›†æ•°: ${episode || 'æœªæŒ‡å®š'}`);
+
+    // å°è¯•å¤šç§æ ‡é¢˜æ ¼å¼è¿›è¡Œæœç´¢
+    const searchTitles = [
+      title, // åŸå§‹æ ‡é¢˜
+      title.replace(/Â·/g, ''), // ç§»é™¤ä¸­é—´ç‚¹
+      title.replace(/Â·/g, ' '), // ä¸­é—´ç‚¹æ›¿æ¢ä¸ºç©ºæ ¼
+      title.replace(/Â·/g, '-'), // ä¸­é—´ç‚¹æ›¿æ¢ä¸ºè¿å­—ç¬¦
+    ];
+
+    // å»é‡
+    const uniqueTitles = Array.from(new Set(searchTitles));
+    console.log(`ğŸ” å°è¯•æœç´¢æ ‡é¢˜å˜ä½“: ${uniqueTitles.map(t => `"${t}"`).join(', ')}`);
+
+    for (const searchTitle of uniqueTitles) {
+      console.log(`ğŸ” æœç´¢æ ‡é¢˜: "${searchTitle}"`);
+      const searchUrl = `https://www.caiji.cyou/api.php/provide/vod/?wd=${encodeURIComponent(searchTitle)}`;
+      const response = await fetch(searchUrl, {
+        headers: {
+          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
+        },
+      });
+
+      if (!response.ok) {
+        console.log(`âŒ æœç´¢"${searchTitle}"å¤±è´¥:`, response.status);
+        continue; // å°è¯•ä¸‹ä¸€ä¸ªæ ‡é¢˜
+      }
+
+      const data: any = await response.json();
+      if (!data.list || data.list.length === 0) {
+        console.log(`ğŸ“­ æœç´¢"${searchTitle}"æœªæ‰¾åˆ°å†…å®¹`);
+        continue; // å°è¯•ä¸‹ä¸€ä¸ªæ ‡é¢˜
+      }
+
+      console.log(`ğŸ¬ æœç´¢"${searchTitle}"æ‰¾åˆ° ${data.list.length} ä¸ªåŒ¹é…ç»“æœ`);
+
+      // æ™ºèƒ½é€‰æ‹©æœ€ä½³åŒ¹é…ç»“æœ
+      let bestMatch: any = null;
+      let exactMatch: any = null;
+
+      for (const result of data.list) {
+        console.log(`ğŸ“‹ å€™é€‰: "${result.vod_name}" (ç±»å‹: ${result.type_name})`);
+
+        // æ ‡é¢˜å®Œå…¨åŒ¹é…ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
+        if (result.vod_name === searchTitle || result.vod_name === title) {
+          console.log(`ğŸ¯ æ‰¾åˆ°å®Œå…¨åŒ¹é…: "${result.vod_name}"`);
+          exactMatch = result;
+          break;
+        }
+
+        // è·³è¿‡æ˜æ˜¾ä¸åˆé€‚çš„å†…å®¹
+        const isUnwanted = result.vod_name.includes('è§£è¯´') || 
+                          result.vod_name.includes('é¢„å‘Š') ||
+                          result.vod_name.includes('èŠ±çµ®') ||
+                          result.vod_name.includes('åŠ¨æ€æ¼«') ||
+                          result.vod_name.includes('ä¹‹ç²¾å½©');
+
+        if (isUnwanted) {
+          console.log(`âŒ è·³è¿‡ä¸åˆé€‚å†…å®¹: "${result.vod_name}"`);
+          continue;
+        }
+
+        // é€‰æ‹©ç¬¬ä¸€ä¸ªåˆé€‚çš„ç»“æœ
+        if (!bestMatch) {
+          bestMatch = result;
+          console.log(`âœ… é€‰æ‹©ä¸ºå€™é€‰: "${result.vod_name}"`);
+        }
+      }
+
+      // ä¼˜å…ˆä½¿ç”¨å®Œå…¨åŒ¹é…ï¼Œå¦åˆ™ä½¿ç”¨æœ€ä½³åŒ¹é…
+      const selectedResult = exactMatch || bestMatch;
+
+      if (selectedResult) {
+        console.log(`âœ… ä½¿ç”¨æœç´¢ç»“æœ"${searchTitle}": "${selectedResult.vod_name}"`);
+        // æ‰¾åˆ°ç»“æœå°±å¤„ç†å¹¶è¿”å›ï¼Œä¸å†å°è¯•å…¶ä»–æ ‡é¢˜å˜ä½“
+        return await processSelectedResult(selectedResult, episode);
+      }
+    }
+
+    console.log('ğŸ“­ æ‰€æœ‰æ ‡é¢˜å˜ä½“éƒ½æœªæ‰¾åˆ°åŒ¹é…å†…å®¹');
+    return [];
+
+  } catch (error) {
+    console.error('âŒ Caiji APIæœç´¢å¤±è´¥:', error);
+    return [];
+  }
+}
+
+// å¤„ç†é€‰ä¸­çš„ç»“æœ
+async function processSelectedResult(selectedResult: any, episode?: string | null): Promise<PlatformUrl[]> {
+  try {
+    console.log(`ğŸ”„ å¤„ç†é€‰ä¸­çš„ç»“æœ: "${selectedResult.vod_name}"`);
+    const firstResult: any = selectedResult;
+    const detailUrl = `https://www.caiji.cyou/api.php/provide/vod/?ac=detail&ids=${firstResult.vod_id}`;
+
+    const detailResponse = await fetch(detailUrl, {
+      headers: {
+        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
+      },
+    });
+
+    if (!detailResponse.ok) return [];
+
+    const detailData: any = await detailResponse.json();
+    if (!detailData.list || detailData.list.length === 0) return [];
+
+    const videoInfo: any = detailData.list[0];
+    console.log(`ğŸ­ è§†é¢‘è¯¦æƒ…: "${videoInfo.vod_name}" (${videoInfo.vod_year})`);
+
+    const urls: PlatformUrl[] = [];
+
+    // è§£ææ’­æ”¾é“¾æ¥
+    if (videoInfo.vod_play_url) {
+      const playUrls = videoInfo.vod_play_url.split('#');
+      console.log(`ğŸ“º æ‰¾åˆ° ${playUrls.length} é›†`);
+
+      // å¦‚æœæŒ‡å®šäº†é›†æ•°ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”é›†æ•°çš„é“¾æ¥
+      let targetUrl = '';
+      if (episode && parseInt(episode) > 0) {
+        const episodeNum = parseInt(episode);
+        // æ”¯æŒå¤šç§é›†æ•°æ ¼å¼: "20$", "ç¬¬20é›†$", "E20$", "EP20$" ç­‰
+        const targetEpisode = playUrls.find((url: string) => {
+          return url.startsWith(`${episodeNum}$`) || 
+                 url.startsWith(`ç¬¬${episodeNum}é›†$`) ||
+                 url.startsWith(`E${episodeNum}$`) ||
+                 url.startsWith(`EP${episodeNum}$`);
+        });
+        if (targetEpisode) {
+          targetUrl = targetEpisode.split('$')[1];
+          console.log(`ğŸ¯ æ‰¾åˆ°ç¬¬${episode}é›†: ${targetUrl}`);
+        } else {
+          console.log(`âŒ æœªæ‰¾åˆ°ç¬¬${episode}é›†çš„é“¾æ¥`);
+        }
+      }
+
+      // å¦‚æœæ²¡æœ‰æŒ‡å®šé›†æ•°æˆ–æ‰¾ä¸åˆ°æŒ‡å®šé›†æ•°ï¼Œä½¿ç”¨ç¬¬ä¸€é›†
+      if (!targetUrl && playUrls.length > 0) {
+        targetUrl = playUrls[0].split('$')[1];
+        console.log(`ğŸ“º ä½¿ç”¨ç¬¬1é›†: ${targetUrl}`);
+      }
+
+      if (targetUrl) {
+        // æ ¹æ®URLåˆ¤æ–­å¹³å°
+        let platform = 'unknown';
+        if (targetUrl.includes('bilibili.com')) {
+          platform = 'bilibili_caiji';
+        } else if (targetUrl.includes('v.qq.com') || targetUrl.includes('qq.com')) {
+          platform = 'tencent_caiji';
+        } else if (targetUrl.includes('iqiyi.com')) {
+          platform = 'iqiyi_caiji';
+        } else if (targetUrl.includes('youku.com') || targetUrl.includes('v.youku.com')) {
+          platform = 'youku_caiji';
+        } else if (targetUrl.includes('mgtv.com') || targetUrl.includes('w.mgtv.com')) {
+          platform = 'mgtv_caiji';
+        }
+
+        // ç»Ÿä¸€ä¿®å¤æ‰€æœ‰å¹³å°çš„é“¾æ¥æ ¼å¼ï¼šå°†.htmè½¬æ¢ä¸º.html
+        if (targetUrl.endsWith('.htm')) {
+          targetUrl = targetUrl.replace(/\.htm$/, '.html');
+          console.log(`ğŸ”§ ä¿®å¤${platform}é“¾æ¥æ ¼å¼: ${targetUrl}`);
+        }
+
+        console.log(`ğŸ¯ è¯†åˆ«å¹³å°: ${platform}, URL: ${targetUrl}`);
+
+        urls.push({
+          platform: platform,
+          url: targetUrl,
+        });
+      }
+    }
+
+    console.log(`âœ… Caiji APIè¿”å› ${urls.length} ä¸ªæ’­æ”¾é“¾æ¥`);
+    return urls;
+
+  } catch (error) {
+    console.error('âŒ Caiji APIæœç´¢å¤±è´¥:', error);
+    return [];
+  }
+}// }}}
+
+// ç”¨æˆ·ä»£ç†æ±  - é˜²æ­¢è¢«å°IP
+const USER_AGENTS = [
+  'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
+  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
+  'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
+];
+
+// è¯·æ±‚é™åˆ¶å™¨ - é˜²æ­¢è¢«å°IP
+let lastDoubanRequestTime = 0;
+const MIN_DOUBAN_REQUEST_INTERVAL = 1000; // 1ç§’æœ€å°é—´éš”
+
+function getRandomUserAgent(): string {
+  return USER_AGENTS[Math.floor(Math.random() * USER_AGENTS.length)];
+}
+
+function randomDelay(min = 500, max = 1500): Promise<void> {
+  const delay = Math.floor(Math.random() * (max - min + 1)) + min;
+  return new Promise(resolve => setTimeout(resolve, delay));
+}
+
+// ä»è±†ç“£é¡µé¢æå–å¹³å°è§†é¢‘é“¾æ¥
+async function extractPlatformUrls(doubanId: string, episode?: string | null): Promise<PlatformUrl[]> {// {{{
+  if (!doubanId) return [];
+
+  // æ·»åŠ è¶…æ—¶æ§åˆ¶ - åœ¨tryå—å¤–å®šä¹‰ä»¥ä¾¿catchå—ä½¿ç”¨
+  const controller = new AbortController();
+  let timeoutId: NodeJS.Timeout | undefined;
+
+  try {
+    // è¯·æ±‚é™æµï¼šç¡®ä¿è¯·æ±‚é—´éš” - é˜²æ­¢è¢«å°IP
+    const now = Date.now();
+    const timeSinceLastRequest = now - lastDoubanRequestTime;
+    if (timeSinceLastRequest < MIN_DOUBAN_REQUEST_INTERVAL) {
+      await new Promise(resolve => 
+        setTimeout(resolve, MIN_DOUBAN_REQUEST_INTERVAL - timeSinceLastRequest)
+      );
+    }
+    lastDoubanRequestTime = Date.now();
+
+    // æ·»åŠ éšæœºå»¶æ—¶ - é˜²æ­¢è¢«å°IP
+    await randomDelay(300, 1000);
+
+    // è®¾ç½®è¶…æ—¶æ§åˆ¶
+    timeoutId = setTimeout(() => controller.abort(), 10000);
+
+    const response = await fetch(`https://movie.douban.com/subject/${doubanId}/`, {
+      signal: controller.signal,
+      headers: {
+        'User-Agent': getRandomUserAgent(),
+        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
+        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
+        'Accept-Encoding': 'gzip, deflate, br',
+        'DNT': '1',
+        'Connection': 'keep-alive',
+        'Upgrade-Insecure-Requests': '1',
+        'Cache-Control': 'max-age=0',
+        // éšæœºæ·»åŠ Referer - é˜²æ­¢è¢«å°IP
+        ...(Math.random() > 0.5 ? { 'Referer': 'https://www.douban.com/' } : {}),
+      },
+    });
+
+    clearTimeout(timeoutId);
+
+    if (!response.ok) {
+      console.log(`âŒ è±†ç“£é¡µé¢è¯·æ±‚å¤±è´¥: ${response.status}`);
+      return [];
+    }
+
+    const html = await response.text();
+    console.log(`ğŸ“„ è±†ç“£é¡µé¢HTMLé•¿åº¦: ${html.length}`);
+    const urls: PlatformUrl[] = [];
+
+    // æå–è±†ç“£è·³è½¬é“¾æ¥ä¸­çš„å„ç§è§†é¢‘å¹³å°URL
+
+    // è…¾è®¯è§†é¢‘
+    const doubanLinkMatches = html.match(/play_link:\s*"[^"]*v\.qq\.com[^"]*"/g);
+    if (doubanLinkMatches && doubanLinkMatches.length > 0) {
+      console.log(`ğŸ¬ æ‰¾åˆ° ${doubanLinkMatches.length} ä¸ªè…¾è®¯è§†é¢‘é“¾æ¥`);
+
+      // å¦‚æœæŒ‡å®šäº†é›†æ•°ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”é›†æ•°çš„é“¾æ¥
+      let selectedMatch = doubanLinkMatches[0]; // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ª
+      if (episode && doubanLinkMatches.length > 1) {
+        const episodeNum = parseInt(episode);
+        if (episodeNum > 0 && episodeNum <= doubanLinkMatches.length) {
+          selectedMatch = doubanLinkMatches[episodeNum - 1];
+          console.log(`ğŸ¯ é€‰æ‹©ç¬¬${episode}é›†è…¾è®¯è§†é¢‘é“¾æ¥`);
+        }
+      }
+
+      const urlMatch = selectedMatch.match(/https%3A%2F%2Fv\.qq\.com[^"&]*/);
+      if (urlMatch) {
+        const decodedUrl = decodeURIComponent(urlMatch[0]).split('?')[0];
+        console.log(`ğŸ”— è…¾è®¯è§†é¢‘é“¾æ¥: ${decodedUrl}`);
+        urls.push({ platform: 'tencent', url: decodedUrl });
+      }
+    }
+
+    // çˆ±å¥‡è‰º
+    const iqiyiMatches = html.match(/play_link:\s*"[^"]*iqiyi\.com[^"]*"/g);
+    if (iqiyiMatches && iqiyiMatches.length > 0) {
+      console.log(`ğŸ“º æ‰¾åˆ° ${iqiyiMatches.length} ä¸ªçˆ±å¥‡è‰ºé“¾æ¥`);
+
+      // å¦‚æœæŒ‡å®šäº†é›†æ•°ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”é›†æ•°çš„é“¾æ¥
+      let selectedMatch = iqiyiMatches[0]; // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ª
+      if (episode && iqiyiMatches.length > 1) {
+        const episodeNum = parseInt(episode);
+        if (episodeNum > 0 && episodeNum <= iqiyiMatches.length) {
+          selectedMatch = iqiyiMatches[episodeNum - 1];
+          console.log(`ğŸ¯ é€‰æ‹©ç¬¬${episode}é›†çˆ±å¥‡è‰ºé“¾æ¥`);
+        }
+      }
+
+      const urlMatch = selectedMatch.match(/https?%3A%2F%2F[^"&]*iqiyi\.com[^"&]*/);
+      if (urlMatch) {
+        const decodedUrl = decodeURIComponent(urlMatch[0]).split('?')[0];
+        console.log(`ğŸ”— çˆ±å¥‡è‰ºé“¾æ¥: ${decodedUrl}`);
+        urls.push({ platform: 'iqiyi', url: decodedUrl });
+      }
+    }
+
+    // ä¼˜é…·
+    const youkuMatches = html.match(/play_link:\s*"[^"]*youku\.com[^"]*"/g);
+    if (youkuMatches && youkuMatches.length > 0) {
+      console.log(`ğŸï¸ æ‰¾åˆ° ${youkuMatches.length} ä¸ªä¼˜é…·é“¾æ¥`);
+
+      // å¦‚æœæŒ‡å®šäº†é›†æ•°ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”é›†æ•°çš„é“¾æ¥
+      let selectedMatch = youkuMatches[0]; // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ª
+      if (episode && youkuMatches.length > 1) {
+        const episodeNum = parseInt(episode);
+        if (episodeNum > 0 && episodeNum <= youkuMatches.length) {
+          selectedMatch = youkuMatches[episodeNum - 1];
+          console.log(`ğŸ¯ é€‰æ‹©ç¬¬${episode}é›†ä¼˜é…·é“¾æ¥`);
+        }
+      }
+
+      const urlMatch = selectedMatch.match(/https?%3A%2F%2F[^"&]*youku\.com[^"&]*/);
+      if (urlMatch) {
+        const decodedUrl = decodeURIComponent(urlMatch[0]).split('?')[0];
+        console.log(`ğŸ”— ä¼˜é…·é“¾æ¥: ${decodedUrl}`);
+        urls.push({ platform: 'youku', url: decodedUrl });
+      }
+    }
+
+    // ç›´æ¥æå–è…¾è®¯è§†é¢‘é“¾æ¥
+    const qqMatches = html.match(/https:\/\/v\.qq\.com\/x\/cover\/[^"'\s]+/g);
+    if (qqMatches && qqMatches.length > 0) {
+      console.log(`ğŸ­ æ‰¾åˆ°ç›´æ¥è…¾è®¯é“¾æ¥: ${qqMatches[0]}`);
+      urls.push({
+        platform: 'tencent_direct',
+        url: qqMatches[0].split('?')[0],
+      });
+    }
+
+    // Bç«™é“¾æ¥æå–ï¼ˆç›´æ¥é“¾æ¥ï¼‰
+    const biliMatches = html.match(/https:\/\/www\.bilibili\.com\/video\/[^"'\s]+/g);
+    if (biliMatches && biliMatches.length > 0) {
+      console.log(`ğŸ“º æ‰¾åˆ°Bç«™ç›´æ¥é“¾æ¥: ${biliMatches[0]}`);
+      urls.push({
+        platform: 'bilibili', 
+        url: biliMatches[0].split('?')[0],
+      });
+    }
+
+    // Bç«™é“¾æ¥æå–ï¼ˆè±†ç“£è·³è½¬é“¾æ¥ï¼‰
+    const biliDoubanMatches = html.match(/play_link:\s*"[^"]*bilibili\.com[^"]*"/g);
+    if (biliDoubanMatches && biliDoubanMatches.length > 0) {
+      console.log(`ğŸ“± æ‰¾åˆ° ${biliDoubanMatches.length} ä¸ªBç«™è±†ç“£é“¾æ¥`);
+
+      // å¦‚æœæŒ‡å®šäº†é›†æ•°ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”é›†æ•°çš„é“¾æ¥
+      let selectedMatch = biliDoubanMatches[0]; // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ª
+      if (episode && biliDoubanMatches.length > 1) {
+        const episodeNum = parseInt(episode);
+        if (episodeNum > 0 && episodeNum <= biliDoubanMatches.length) {
+          selectedMatch = biliDoubanMatches[episodeNum - 1];
+          console.log(`ğŸ¯ é€‰æ‹©ç¬¬${episode}é›†Bç«™è±†ç“£é“¾æ¥`);
+        }
+      }
+
+      const urlMatch = selectedMatch.match(/https?%3A%2F%2F[^"&]*bilibili\.com[^"&]*/);
+      if (urlMatch) {
+        const decodedUrl = decodeURIComponent(urlMatch[0]).split('?')[0];
+        console.log(`ğŸ”— Bç«™è±†ç“£é“¾æ¥: ${decodedUrl}`);
+        urls.push({ platform: 'bilibili_douban', url: decodedUrl });
+      }
+    }
+
+    // è½¬æ¢ç§»åŠ¨ç‰ˆé“¾æ¥ä¸ºPCç‰ˆé“¾æ¥ï¼ˆå¼¹å¹•åº“APIéœ€è¦PCç‰ˆï¼‰
+    const convertedUrls = urls.map(urlObj => {
+      let convertedUrl = urlObj.url;
+
+      // ä¼˜é…·ç§»åŠ¨ç‰ˆè½¬PCç‰ˆ
+      if (convertedUrl.includes('m.youku.com/alipay_video/id_')) {
+        convertedUrl = convertedUrl.replace(
+          /https:\/\/m\.youku\.com\/alipay_video\/id_([^.]+)\.html/,
+          'https://v.youku.com/v_show/id_$1.html'
+        );
+        console.log(`ğŸ”„ ä¼˜é…·ç§»åŠ¨ç‰ˆè½¬PCç‰ˆ: ${convertedUrl}`);
+      }
+
+      // çˆ±å¥‡è‰ºç§»åŠ¨ç‰ˆè½¬PCç‰ˆ
+      if (convertedUrl.includes('m.iqiyi.com/')) {
+        convertedUrl = convertedUrl.replace('m.iqiyi.com', 'www.iqiyi.com');
+        console.log(`ğŸ”„ çˆ±å¥‡è‰ºç§»åŠ¨ç‰ˆè½¬PCç‰ˆ: ${convertedUrl}`);
+      }
+
+      // è…¾è®¯è§†é¢‘ç§»åŠ¨ç‰ˆè½¬PCç‰ˆ
+      if (convertedUrl.includes('m.v.qq.com/')) {
+        convertedUrl = convertedUrl.replace('m.v.qq.com', 'v.qq.com');
+        console.log(`ğŸ”„ è…¾è®¯ç§»åŠ¨ç‰ˆè½¬PCç‰ˆ: ${convertedUrl}`);
+      }
+
+      // Bç«™ç§»åŠ¨ç‰ˆè½¬PCç‰ˆ
+      if (convertedUrl.includes('m.bilibili.com/')) {
+        convertedUrl = convertedUrl.replace('m.bilibili.com', 'www.bilibili.com');
+        // ç§»é™¤è±†ç“£æ¥æºå‚æ•°
+        convertedUrl = convertedUrl.split('?')[0];
+        console.log(`ğŸ”„ Bç«™ç§»åŠ¨ç‰ˆè½¬PCç‰ˆ: ${convertedUrl}`);
+      }
+
+      return { ...urlObj, url: convertedUrl };
+    });
+
+    console.log(`âœ… æ€»å…±æå–åˆ° ${convertedUrls.length} ä¸ªå¹³å°é“¾æ¥`);
+    return convertedUrls;
+  } catch (error) {
+    // æ¸…ç†è¶…æ—¶å®šæ—¶å™¨
+    if (timeoutId) {
+      clearTimeout(timeoutId);
+    }
+
+    if (error instanceof DOMException && error.name === 'AbortError') {
+      console.error('âŒ è±†ç“£è¯·æ±‚è¶…æ—¶ (10ç§’):', doubanId);
+    } else {
+      console.error('âŒ æå–å¹³å°é“¾æ¥å¤±è´¥:', error);
+    }
+    return [];
+  }
+}// }}}
+
+
+// è·å–é¦–ä¸ªå¯ç”¨çš„ URL from XML API, https://github.com/lyz05/danmaku
+async function firstDanmuXmlUrl(platform: string, videoUrl: string, timeout: number): Promise<string> {
+  const xmlApiUrls = [
+    'https://fc.lyz05.cn',
+    'https://danmu.smone.us'
+  ];
+
+  // å°è¯•æ¯ä¸ªAPI URL
+  for (let i = 0; i < xmlApiUrls.length; i++) {
+    const baseUrl = xmlApiUrls[i];
+    const apiName = i === 0 ? 'ä¸»ç”¨XML API' : `å¤‡ç”¨XML API ${i}`;
+    const controller = new AbortController();
+    const timeoutId = setTimeout(() => controller.abort(), timeout);
+
+    try {
+      const apiUrl = `${baseUrl}/?url=${encodeURIComponent(videoUrl)}`;
+      console.log(`ğŸŒ [å¹³å° ${platform}] æ­£åœ¨æµ‹è¯•è¯·æ±‚${apiName}:`, apiUrl);
+      const response = await fetch(apiUrl, {
+        method: 'HEAD', // ä½¿ç”¨ HEAD æ–¹æ³•ï¼Œåªæ£€æŸ¥å“åº”å¤´
+        signal: controller.signal,
+        headers: {
+          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
+          'Accept': 'application/xml, text/xml, */*',
+          'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
+        },
+      });
+
+      clearTimeout(timeoutId);
+      console.log(`ğŸ“¡ [å¹³å° ${platform}] ${apiName}å“åº”çŠ¶æ€:`, response.status, response.statusText);
+
+      if (!response.ok) {
+        console.log(`âŒ [å¹³å° ${platform}] ${apiName}å“åº”å¤±è´¥:`, response.status);
+        continue; // å°è¯•ä¸‹ä¸€ä¸ªAPI
+      } else {
+        // è¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸçš„API
+        return apiUrl;
+      }
+    } catch (error) {
+      clearTimeout(timeoutId);
+      if (error instanceof DOMException && error.name === 'AbortError') {
+        console.error(`âŒ [å¹³å° ${platform}] ${apiName}è¯·æ±‚è¶…æ—¶ (${timeout/1000}ç§’):`, videoUrl);
+      } else {
+        console.error(`âŒ [å¹³å° ${platform}] ${apiName}è¯·æ±‚å¤±è´¥:`, error);
+      }
+      // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªAPI
+    }
+  }
+
+  // æ‰€æœ‰APIéƒ½å¤±è´¥äº†
+  console.log(`âŒ [å¹³å° ${platform}] æ‰€æœ‰å¼¹å¹• XML API å‡è¯·æ±‚å¤±è´¥ï¼`);
+  return '';
+}
+
+export async function GET(request: NextRequest) {
+  const { searchParams } = new URL(request.url);
+  const doubanId = searchParams.get('douban_id');
+  const title = searchParams.get('title');
+  const episode = searchParams.get('episode'); // é›†æ•°å‚æ•°ï¼Œé»˜è®¤ç¬¬1é›†
+  const timeout = parseInt(searchParams.get('timeout') ?? '8') || 8; // æµ‹è¯•è¶…æ—¶ second
+
+  console.log(`==> å¼¹å¹•APIè¯·æ±‚å‚æ•°: è±†ç“£ID = ${doubanId}, æ ‡é¢˜ = ${title}, é›†æ•° = ${episode}, è¶…æ—¶ = ${timeout}s`);
+
+  if (!doubanId && !title) {
+    console.log("âŒ ç¼ºå°‘å‚æ•°ï¼šdouban_id or title");
+    return NextResponse.json({
+      error: 'Missing required parameters: douban_id or title'
+    }, { status: 400 });
+  }
+
+  try {
+    let platformUrls: PlatformUrl[] = [];
+
+    // ä¼˜å…ˆä»è±†ç“£é¡µé¢æå–é“¾æ¥
+    if (doubanId) {
+      console.log('ğŸ” ä¼˜å…ˆä»è±†ç“£é¡µé¢æå–é“¾æ¥...');
+      platformUrls = await extractPlatformUrls(doubanId, episode);
+      console.log('ğŸ“ è±†ç“£æå–ç»“æœ:', platformUrls);
+    }
+
+    // å¦‚æœè±†ç“£æ²¡æœ‰ç»“æœï¼Œä½¿ç”¨caiji.cyou APIä½œä¸ºå¤‡ç”¨
+    if (platformUrls.length === 0 && title) {
+      console.log('ğŸ” è±†ç“£æœªæ‰¾åˆ°é“¾æ¥ï¼Œä½¿ç”¨Caiji APIå¤‡ç”¨æœç´¢...');
+      const caijiUrls = await searchFromCaijiAPI(title, episode);
+      if (caijiUrls.length > 0) {
+        platformUrls = caijiUrls;
+        console.log('ğŸ“º Caiji APIå¤‡ç”¨ç»“æœ:', platformUrls);
+      }
+    }
+
+    // æ‰¾ä¸åˆ°ä»»ä½•é“¾æ¥
+    if (platformUrls.length === 0) {
+      console.log(`âŒ æœªæ‰¾åˆ°ä»»ä½•"${title}"çš„è§†é¢‘å¹³å°é“¾æ¥ï¼Œæ— å¼¹å¹• XML URL`);
+      return NextResponse.json({
+        error: 'No video link found'
+      }, { status: 404 });
+    }
+
+    // å¹¶å‘æµ‹è¯•å¤šä¸ªå¹³å°çš„ XML API
+    const danmuXmlPromises = platformUrls.map(async ({ platform, url }) => {
+      const xmlurl = await firstDanmuXmlUrl(platform, url, timeout*1000);
+      return { platform, xmlurl };
+    });
+    const results = await Promise.allSettled(danmuXmlPromises);
+
+    const platforms: string[] = [];
+    const xmlurls: string[] = [];
+    results.forEach((result) => {
+      if (result.status === 'fulfilled' && result.value.xmlurl) {
+        platforms.push(result.value.platform);
+        xmlurls.push(result.value.xmlurl);
+      }
+    });
+
+    return NextResponse.json({
+      platforms: platforms,
+      xmlurls: xmlurls,
+      total: xmlurls.length,
+    });
+
+  } catch (error) {
+    console.error('è·å–å¼¹å¹• XML URL å¤±è´¥:', error);
+    return NextResponse.json({ 
+      error: 'Failed to get the danmaku XML URL',
+    }, { status: 500 });
+  }
+}
diff -Nur v100/src/app/api/m3u8filter-register/route.ts open-with-mpv/src/app/api/m3u8filter-register/route.ts
--- v100/src/app/api/m3u8filter-register/route.ts	1970-01-01 08:00:00.000000000 +0800
+++ open-with-mpv/src/app/api/m3u8filter-register/route.ts	2025-09-28 19:01:21.275381037 +0800
@@ -0,0 +1,2 @@
+export const runtime = 'nodejs';
+export { POST } from '@/lib/m3u8filter';
diff -Nur v100/src/app/api/registered-m3u8filter/route.ts open-with-mpv/src/app/api/registered-m3u8filter/route.ts
--- v100/src/app/api/registered-m3u8filter/route.ts	1970-01-01 08:00:00.000000000 +0800
+++ open-with-mpv/src/app/api/registered-m3u8filter/route.ts	2025-09-28 19:01:43.241380644 +0800
@@ -0,0 +1,2 @@
+export const runtime = 'nodejs';
+export { GET } from '@/lib/m3u8filter';
diff -Nur v100/src/app/play/page.tsx open-with-mpv/src/app/play/page.tsx
--- v100/src/app/play/page.tsx	2025-09-25 00:54:27.000000000 +0800
+++ open-with-mpv/src/app/play/page.tsx	2025-09-28 10:17:46.267943620 +0800
@@ -42,6 +42,8 @@
   removeEventListener(type: 'release', listener: () => void): void;
 }
 
+import MPVPlayButton from '@/components/MPVPlayButton';
+
 function PlayPageClient() {
   const router = useRouter();
   const searchParams = useSearchParams();
@@ -1838,6 +1840,15 @@
                 {` > ${detail?.episodes_titles?.[currentEpisodeIndex] || `ç¬¬ ${currentEpisodeIndex + 1} é›†`}`}
               </span>
             )}
+            {/* éç§»åŠ¨è®¾å¤‡ï¼ŒåŒä¸€è¡Œä½¿ç”¨ MPVPlayButton ç»„ä»¶ */}
+            <MPVPlayButton
+              videoUrl={videoUrl}
+              videoTitle={videoTitle}
+              videoDoubanId={videoDoubanId}
+              detail={detail}
+              currentEpisodeIndex={currentEpisodeIndex}
+              artPlayerRef={artPlayerRef}
+            />
           </h1>
         </div>
         {/* ç¬¬äºŒè¡Œï¼šæ’­æ”¾å™¨å’Œé€‰é›† */}
diff -Nur v100/src/components/MPVPlayButton.tsx open-with-mpv/src/components/MPVPlayButton.tsx
--- v100/src/components/MPVPlayButton.tsx	1970-01-01 08:00:00.000000000 +0800
+++ open-with-mpv/src/components/MPVPlayButton.tsx	2025-09-28 19:11:34.623370053 +0800
@@ -0,0 +1,325 @@
+'use client';
+
+import { useState, useEffect, useRef, useCallback } from 'react';
+import { SearchResult } from '@/lib/types';
+
+interface MPVPlayButtonProps {
+  videoUrl: string;
+  videoTitle: string;
+  videoDoubanId: number;
+  detail: SearchResult | null;
+  currentEpisodeIndex: number;
+  artPlayerRef: React.MutableRefObject<any>;
+}
+
+// å·¥å…·å‡½æ•°ï¼šå®‰å…¨ base64 ç¼–ç 
+const safeU8Base64 = (str: string): string => {
+  const b64 = btoa(unescape(encodeURIComponent(str)));
+  return b64.replace(/\//g, "_").replace(/\+/g, "-").replaceAll("=", "");
+};
+
+// å·¥å…·å‡½æ•°ï¼šæ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
+const isMobileDevice = (): boolean => {
+  if (typeof navigator === 'undefined') return false;
+  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
+};
+
+// å¼¹å¹• URL åœ°å€ API å“åº”ç±»å‹
+interface DanmakuUrlsResponse {
+  total: number;
+  platforms: string[];
+  xmlurls: string[];
+}
+
+// ç¼“å­˜æ¥å£
+interface CacheEntry {
+  data: DanmakuUrlsResponse | null;
+  timestamp: number;
+  loading: boolean;
+}
+
+// å¼¹å¹• URL åœ°å€ API ç¼“å­˜ï¼ˆå†…å­˜ç¼“å­˜ï¼‰
+const danmakuUrlsCache = new Map<string, CacheEntry>();
+
+// è·å–ç¼“å­˜é”®
+const getCacheKey = (doubanId: number, title: string, episode: number): string => {
+  return `${doubanId}-${title}-${episode}`;
+};
+
+export default function MPVPlayButton({
+  videoUrl,
+  videoTitle,
+  videoDoubanId,
+  detail,
+  currentEpisodeIndex,
+  artPlayerRef
+}: MPVPlayButtonProps) {
+  const [isMobile, setIsMobile] = useState(false);
+  const [filteredVideoUrl, setFilteredVideoUrl] = useState<string>(''); // è¿‡æ»¤åçš„è§†é¢‘åœ°å€
+  const [danmakuUrlsStatus, setDanmakuUrlsStatus] = useState<'idle' | 'loading' | 'ready' | 'error'>('idle');
+
+  // ä½¿ç”¨ ref å­˜å‚¨å½“å‰ç¼“å­˜é”®ï¼Œé¿å…é‡å¤è¯·æ±‚
+  const currentCacheKeyRef = useRef<string>('');
+
+  // æ£€æµ‹è®¾å¤‡ç±»å‹
+  useEffect(() => {
+    setIsMobile(isMobileDevice());
+  }, []);
+
+  // ç”Ÿæˆå”¯ä¸€çš„ä¸´æ—¶ key for filteredVideoUrl
+  const generateTempKey = useCallback((url: string): string => {
+    // ä½¿ç”¨ç®€å•çš„å“ˆå¸Œå‡½æ•°å¤„ç† url
+    let hash = 0;
+    for (let i = 0; i < url.length; i++) {
+      const char = url.charCodeAt(i);
+      hash = ((hash << 5) - hash) + char;
+      hash = hash & hash; // Convert to 32bit integer
+    }
+    // timestamp
+    const random = (Math.floor(Date.now()*Math.random())).toString(36);
+    return `${Math.abs(hash).toString(36)}-${random}`;
+  }, []);
+
+  // è¿‡æ»¤ M3U8 åœ°å€ - ä½¿ç”¨ä¸´æ—¶è®¤è¯çš„ key
+  const filterM3U8Url = useCallback(async (url: string): Promise<string> => {
+    // å¦‚æœä¸æ˜¯ m3u8 åœ°å€æˆ–è€…å»è¿‡æ»¤åŠŸèƒ½å…³é—­ï¼Œç›´æ¥è¿”å›åŸåœ°å€
+    if (!url.includes('.m3u8') || process.env.MPV_FILTER_M3U8 === 'off') {
+      return url;
+    }
+
+    try {
+      console.log('[MPV] å¼€å§‹æ³¨å†Œè¿‡æ»¤ M3U8 åœ°å€:', url);
+      // ç”Ÿæˆä¸´æ—¶ key
+      const tmpKey = generateTempKey(url);
+      const urlKey = `${tmpKey}.m3u8`;
+
+      // å‘é€ POST è¯·æ±‚æ³¨å†Œ key
+      const response = await fetch('/api/m3u8filter-register', {
+        method: 'POST',
+        headers: {
+          'Content-Type': 'application/json',
+        },
+        body: JSON.stringify({
+          url_key: urlKey,
+          original_url: url
+        })
+      });
+
+      if (response.ok) {
+        const result = await response.json();
+        if (result.success) {
+          // æ„å»ºæ–°çš„è¿‡æ»¤åœ°å€
+          // é€šè¿‡ middleware åŒ¹é…: api/registerï¼Œmpv è·³è¿‡è®¤è¯
+          const filteredUrl = `${window.location.origin}/api/registered-m3u8filter?url_key=${urlKey}`;
+          console.log('[MPV] M3U8 è¿‡æ»¤æ³¨å†ŒæˆåŠŸï¼Œä½¿ç”¨è¿‡æ»¤ååœ°å€:', filteredUrl);
+          return filteredUrl;
+        } else {
+          console.warn('[MPV] M3U8 è¿‡æ»¤æ³¨å†Œå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹åœ°å€');
+          return url;
+        }
+      } else {
+        console.warn('[MPV] M3U8 è¿‡æ»¤æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹åœ°å€');
+        return url;
+      }
+    } catch (error) {
+      console.error('[MPV] M3U8 è¿‡æ»¤æ³¨å†Œé”™è¯¯:', error);
+      return url;
+    }
+  }, [generateTempKey]);
+
+  // å¤„ç†è§†é¢‘åœ°å€è¿‡æ»¤
+  useEffect(() => {
+    const processVideoUrl = async () => {
+      if (!videoUrl) {
+        setFilteredVideoUrl('');
+        return;
+      }
+      console.log('[MPV] åŸå§‹è§†é¢‘åœ°å€ï¼š', videoUrl);
+      const filteredUrl = await filterM3U8Url(videoUrl);
+      setFilteredVideoUrl(filteredUrl);
+      console.log('[MPV] æœ€ç»ˆè§†é¢‘åœ°å€ï¼š', filteredUrl);
+    };
+    processVideoUrl();
+  }, [videoUrl, filterM3U8Url]);
+
+  // é¢„å…ˆåŠ è½½å¼¹å¹• URL åœ°å€
+  useEffect(() => {
+    if (isMobile || (!videoDoubanId && !videoTitle)) return;
+
+    const cacheKey = getCacheKey(videoDoubanId, videoTitle, currentEpisodeIndex + 1);
+    currentCacheKeyRef.current = cacheKey;
+
+    // æ£€æŸ¥ç¼“å­˜
+    const cachedEntry = danmakuUrlsCache.get(cacheKey);
+    if (cachedEntry) {
+      setDanmakuUrlsStatus(cachedEntry.data ? 'ready' : 'error');
+      return; // ä½¿ç”¨æœ‰æ•ˆç¼“å­˜
+    }
+
+    // æ ‡è®°ä¸ºå¼¹å¹• URL åŠ è½½ä¸­
+    setDanmakuUrlsStatus('loading');
+    danmakuUrlsCache.set(cacheKey, { data: null, timestamp: Date.now(), loading: true });
+
+    const preloadDanmakuUrls = async () => {
+      try {
+        const params = new URLSearchParams();
+        if (videoDoubanId > 0) {
+          params.append('douban_id', videoDoubanId.toString());
+        }
+        if (videoTitle) {
+          params.append('title', videoTitle);
+        }
+        if (currentEpisodeIndex > 0) {
+          params.append('episode', (currentEpisodeIndex + 1).toString());
+        }
+        params.append('timeout', '10');
+
+        console.log('[MPV] é¢„åŠ è½½å¼¹å¹• URL è¯·æ±‚å‚æ•°:', params.toString());
+        const response = await fetch(`/api/danmaku-xmlurl?${params.toString()}`, {
+          headers: { 'Content-Type': 'application/json' },
+        });
+
+        if (response.ok) {
+          const urlsData = await response.json();
+          if (urlsData && urlsData.total > 0) {
+            // æ›´æ–°ç¼“å­˜
+            danmakuUrlsCache.set(cacheKey, {
+              data: urlsData,
+              timestamp: Date.now(),
+              loading: false
+            });
+            setDanmakuUrlsStatus('ready');
+            console.log('[MPV] å¼¹å¹• URL åœ°å€é¢„åŠ è½½å®Œæˆ');
+          } else {
+            // å³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿç¼“å­˜ç»“æœï¼Œé¿å…é‡å¤è¯·æ±‚
+            danmakuUrlsCache.set(cacheKey, {
+              data: null,
+              timestamp: Date.now(),
+              loading: false
+            });
+            setDanmakuUrlsStatus('error');
+            console.log('[MPV] å¼¹å¹• URL åœ°å€ä¸ºç©º');
+          }
+        } else {
+          const errorText = await response.text();
+          console.error('[MPV] å¼¹å¹• URL åœ°å€é¢„åŠ è½½å¤±è´¥:', response.status, errorText);
+          danmakuUrlsCache.set(cacheKey, {
+            data: null,
+            timestamp: Date.now(),
+            loading: false
+          });
+          setDanmakuUrlsStatus('error');
+        }
+      } catch (error) {
+        console.error('[MPV] å¼¹å¹• URL åœ°å€é¢„åŠ è½½å¼‚å¸¸:', error);
+        danmakuUrlsCache.set(cacheKey, {
+          data: null,
+          timestamp: Date.now(),
+          loading: false
+        });
+        setDanmakuUrlsStatus('error');
+      }
+    };
+
+    preloadDanmakuUrls();
+  }, [videoDoubanId, videoTitle, currentEpisodeIndex, isMobile]);
+
+  // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆ MPV æ’­æ”¾åœ°å€ï¼ˆåŒæ­¥å‡½æ•°ï¼Œä½¿ç”¨é¢„åŠ è½½çš„å¼¹å¹• URL åœ°å€ï¼‰
+  const generateMPVUrl = (currentTime?: number): string => {
+    const finalVideoUrl = filteredVideoUrl || videoUrl;
+    console.log('[MPV] è§†é¢‘åœ°å€ï¼š', finalVideoUrl);
+    const v_title = (detail?.episodes?.length || 0) > 1
+      ? `${videoTitle || 'å½±ç‰‡æ ‡é¢˜'} - ${detail?.episodes_titles?.[currentEpisodeIndex] || `ç¬¬${currentEpisodeIndex + 1}é›†`}`
+      : `${videoTitle || 'å½±ç‰‡æ ‡é¢˜'}`;
+    console.log('[MPV] è§†é¢‘æ ‡é¢˜ï¼š', v_title);
+    let mpvurl = `mpv://play/${safeU8Base64(finalVideoUrl)}/?v_title=${safeU8Base64(v_title)}`;
+
+    // ä½¿ç”¨é¢„åŠ è½½çš„å¼¹å¹• URL åœ°å€
+    const cacheKey = currentCacheKeyRef.current;
+    const cachedEntry = danmakuUrlsCache.get(cacheKey);
+    if (cachedEntry && cachedEntry.data && cachedEntry.data.total > 0) {
+      console.log('[MPV] ä½¿ç”¨é¢„åŠ è½½çš„å¼¹å¹• URL åœ°å€');
+      const urlsData = cachedEntry.data;
+      // platforms, xmlurls
+      for (let i = 0; i < urlsData.total; i++) {
+        const danmurl = urlsData.xmlurls[i];
+        const platform = urlsData.platforms[i];
+        console.log(`[MPV] æ·»åŠ  ${platform} å¼¹å¹•åœ°å€ï¼š`, danmurl);
+        mpvurl += `&danmaku_xmlurl=${safeU8Base64(danmurl)}`;
+      }
+    } else {
+      console.log('[MPV] æ— å¼¹å¹• URL åœ°å€å¯ç”¨');
+    }
+
+    // æ·»åŠ å¼€å§‹æ—¶é—´ï¼Œè‹¥æ’­æ”¾æ—¶é—´å¤§äº5ç§’
+    if (currentTime && currentTime > 5) {
+      mpvurl += `&startat=${Math.floor(currentTime) - 1}`;
+    }
+
+    console.log('[MPV] æ’­æ”¾åœ°å€ï¼š', mpvurl);
+    return mpvurl;
+  };
+
+  // å¦‚æœæ²¡æœ‰è§†é¢‘åœ°å€æˆ–æ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œä¸æ¸²æŸ“æŒ‰é’®
+  if (!videoUrl || isMobile) {
+    return null;
+  }
+
+  const handleMPVPlay = () => {
+    const currentPlayTime = artPlayerRef.current?.currentTime || 0;
+    const finalMpvUrl = generateMPVUrl(currentPlayTime);
+
+    // æš‚åœæ’­æ”¾å™¨
+    if (artPlayerRef.current && !artPlayerRef.current.paused) {
+      artPlayerRef.current.pause();
+    }
+
+    // æ‰“å¼€ MPV æ’­æ”¾çª—å£
+    //  "_blank": æ–°çª—å£ã€‚artPlayer ä»…æš‚åœã€‚
+    //  "_self": é¡µé¢å¸è½½æ—¶, handleBeforeUnload, artPlayer èµ„æºä¼šè¢«æ¸…ç†ï¼Œæ¯”ä»…æš‚åœæ›´çœèµ„æºã€‚(NOT-TODO) å¯æ·»åŠ çŠ¶æ€åˆ¤æ–­ï¼Œé˜»æ­¢æ¸…ç†ã€‚
+    //  "open-with-mpv": specified æ–°çª—å£ï¼Œé¿å…å¤šä¸ª blank çª—å£ã€‚
+    const targetName = "open-with-mpv";
+    const targetTitle = `${document.title} | MPV`;
+    const mpvWindow = window.open(finalMpvUrl, targetName);
+
+    if (mpvWindow && mpvWindow.document) {
+      mpvWindow.document.title = targetTitle;
+    }
+  };
+
+  // æ ¹æ® filteredVideoUrlæ˜¾ç¤ºä¸åŒçš„æŒ‰é’® title
+  const getButtonTitle = () => {
+    if (filteredVideoUrl !== videoUrl) {
+        return `${videoUrl} -> ${filteredVideoUrl}`;
+    } else {
+      return videoUrl;
+    }
+  };
+
+  // æ ¹æ®å¼¹å¹• URL åœ°å€é¢„åŠ è½½çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æŒ‰é’®æ–‡æœ¬
+  const getButtonText = () => {
+    switch (danmakuUrlsStatus) {
+      case 'loading':
+        return <span>MPV æ’­æ”¾ (å¼¹å¹•URLåŠ è½½ä¸­...)</span>;
+      case 'ready':
+        return <span>MPV æ’­æ”¾ âœ“</span>;
+      case 'error':
+        return <span>MPV æ’­æ”¾ (æ— å¼¹å¹•)</span>;
+      default:
+        return <span>MPV æ’­æ”¾</span>;
+    }
+  };
+
+  return (
+    <button
+      onClick={handleMPVPlay}
+      disabled={danmakuUrlsStatus === 'loading'}
+      className="ml-4 flex-shrink-0 hover:opacity-90 transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
+      title={getButtonTitle()}
+    >
+      <div className="flex items-center gap-1.5 bg-blue-200 hover:bg-blue-400 dark:bg-blue-600 dark:hover:bg-blue-800 text-gray-600 dark:text-gray-300 px-3 py-1.5 rounded-full text-sm font-semibold shadow-md">
+        {getButtonText()}
+      </div>
+    </button>
+  );
+}
diff -Nur v100/src/lib/m3u8filter.ts open-with-mpv/src/lib/m3u8filter.ts
--- v100/src/lib/m3u8filter.ts	1970-01-01 08:00:00.000000000 +0800
+++ open-with-mpv/src/lib/m3u8filter.ts	2025-09-28 18:25:00.623420088 +0800
@@ -0,0 +1,58 @@
+/* eslint-disable no-console */
+
+import { NextRequest, NextResponse } from 'next/server';
+import { getAuthInfoFromCookie } from '@/lib/auth';
+
+export const runtime = 'nodejs';
+
+const registeredKeys = new Map<string, { url: string; timestamp: number }>();
+
+export async function POST(request: NextRequest) {
+  try {
+    // ä» cookie è·å–ç”¨æˆ·ä¿¡æ¯
+    const authInfo = getAuthInfoFromCookie(request);
+    if (!authInfo || !authInfo.username) {
+      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
+    }
+
+    const { url_key, original_url } = await request.json();
+    // éªŒè¯å‚æ•°
+    if (!url_key || !original_url) {
+      return NextResponse.json({ success: false, error: 'Missing parameters' }, { status: 400 });
+    }
+    // æ³¨å†Œ key
+    registeredKeys.set(url_key, {
+      url: original_url,
+      timestamp: Date.now()
+    });
+    // è®¾ç½®è¿‡æœŸæ—¶é—´: 1å°æ—¶
+    setTimeout(() => {
+      registeredKeys.delete(url_key);
+    }, 60 * 60 * 1000);
+    return NextResponse.json({ success: true });
+  } catch (error) {
+    return NextResponse.json({ success: false, error: 'Invalid request' }, { status: 400 });
+  }
+}
+
+export async function GET(request: NextRequest) {
+  // "ä¸"éªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼Œæ–¹ä¾¿ mpv è®¿é—®
+  const { searchParams } = new URL(request.url);
+  const url_key = searchParams.get('url_key');
+  if (!url_key || !registeredKeys.has(url_key)) {
+    return new Response('Not Found', { status: 404 });
+  }
+  const entry = registeredKeys.get(url_key);
+  if (!entry) {
+    return new Response('Not Found', { status: 404 });
+  }
+
+  // åœ¨è¿™é‡Œå®ç° m3u8 è¿‡æ»¤é€»è¾‘
+  // ä½¿ç”¨ entry.url è·å–åŸå§‹ m3u8 å†…å®¹å¹¶è¿‡æ»¤
+
+  return new Response('Filtered m3u8 content', {
+    headers: {
+      'Content-Type': 'application/vnd.apple.mpegurl',
+    },
+  });
+}
